<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>sanad friend — تسجيل الدخول</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%232563eb'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-size='28' fill='white' font-family='Arial'%3ESF%3C/text%3E%3C/svg%3E">
  <style>
    :root{--bg:#0b1224;--card:#101a34;--muted:#8fa3c7;--txt:#e9eef9;--ok:#22c55e;--err:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1224,#0e1630 40%,#0b1224);color:var(--txt);
      font-family:"Cairo","Tajawal",system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.7}
    .wrap{max-width:780px;margin:6vh auto;padding:16px}
    .card{background:var(--card);border:1px solid #1d2a52;border-radius:20px;box-shadow:0 20px 60px #00000055;padding:22px}
    h1{margin:0 0 10px;font-weight:800}
    p.muted{color:var(--muted);margin:4px 0 18px}
    button{cursor:pointer;border:1px solid #27406f;background:#152857;color:#fff;padding:12px 18px;border-radius:14px;font-weight:700}
    button.primary{background:linear-gradient(135deg,#2563eb,#4cc9f0);border:0}
    button.link{background:transparent;border:0;color:#a6c8ff;text-decoration:underline;padding:0}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px dashed #24417a;border-radius:12px;padding:10px 12px}
    .key{color:#98b0dc;font-size:.95rem}.val{font-weight:700}
    .footer{opacity:.7;font-size:.9rem;margin-top:14px}
    code{background:#0b1329;border:1px solid #20325f;border-radius:8px;padding:2px 6px}
    .ltr{direction:ltr; unicode-bidi:plaintext;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>sanad friend — تسجيل الدخول</h1>
      <p class="muted">
        تسجيل عبر Amazon Cognito (Authorization Code + PKCE). بعد النجاح، بنحفظ <b>userId / name / birth / phone number / email</b>
        كل واحدة في مفتاح مستقل داخل <code>sessionStorage</code>.
      </p>

      <div id="signed-out"><button id="btnSignIn" class="primary">تسجيل الدخول</button></div>

      <div id="signed-in" style="display:none">
        <div class="grid" id="claims"></div>
        <div style="display:flex;gap:10px;margin-top:14px">
          <button id="btnCopy">نسخ القيم الخمسة</button>
          <button id="btnSignOut">تسجيل الخروج</button>
          <button id="btnClearLocal" class="link" title="مسح SessionStorage فقط">مسح SessionStorage فقط</button>
        </div>
        <p class="footer">مفاتيح التخزين: <code>userId</code>, <code>name</code>, <code>birth</code>, <code>phone number</code>, <code>email</code></p>
      </div>

      <p id="msg" class="footer"></p>
    </div>
  </div>

  <script>
    // ========= إعداداتك =========
    const CONFIG = Object.freeze({
      PROGRAM_NAME: "sanad friend",
      CLIENT_ID: "1ckgnpptbiq3aopekr9kt54aoh",
      COGNITO_DOMAIN: "https://us-east-1fth1loy0b.auth.us-east-1.amazoncognito.com",
      REDIRECT_URI: "https://sanadfriend.github.io/sanadfriend/",
      SCOPES: ["openid","email","phone","profile"], // ضروري لـ name/birthdate
    });

    // ========= مفاتيح مؤقتة لرحلة PKCE/state (لا تُخزن بيانات المستخدم الأخرى) =========
    const TMP = Object.freeze({ PKCE_VERIFIER:"SF_PKCE_VERIFIER", OAUTH_STATE:"SF_OAUTH_STATE" });

    // ========= Helpers =========
    const $ = s => document.querySelector(s);
    const msg = (t, ok=true)=>{ const el=$("#msg"); el.textContent=t||""; el.style.color=ok?"#9fe6b8":"#ffb4b4"; };
    const b64url = (buf)=>{ let str=typeof buf==="string"?buf:String.fromCharCode(...new Uint8Array(buf));
      return btoa(str).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); };
    const b64urlToUint8 = (s)=>{ s=s.replace(/-/g,"+").replace(/_/g,"/"); const pad=s.length%4?4-(s.length%4):0;
      const b64=s+"=".repeat(pad); const raw=atob(b64); const out=new Uint8Array(raw.length);
      for(let i=0;i<raw.length;i++) out[i]=raw.charCodeAt(i); return out; };
    const sha256 = (str)=>crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
    const randStr=(n=64)=>{ const a=new Uint8Array(n); crypto.getRandomValues(a); return b64url(a); };
    const createPKCE = async()=>{ const v=randStr(64); const c=b64url(await sha256(v)); return {verifier:v, challenge:c}; };
    const decodeJwt = (jwt)=>{ const [,p]=String(jwt).split("."); try{ return JSON.parse(new TextDecoder().decode(b64urlToUint8(p))); }catch{ return {}; } };

    // تخزين مؤقت resilient لمتغيرات الرحلة فقط
    const tempStore = {
      set:(k,v)=>{ try{sessionStorage.setItem(k,JSON.stringify(v));}catch{} try{localStorage.setItem(k,JSON.stringify(v));}catch{} },
      get:(k)=>{ let v=null; try{v=sessionStorage.getItem(k);}catch{} if(v==null){ try{v=localStorage.getItem(k);}catch{} }
                 try{return v!=null?JSON.parse(v):null;}catch{return null;} },
      del:(k)=>{ try{sessionStorage.removeItem(k);}catch{} try{localStorage.removeItem(k);}catch{} },
    };

    // ========= حفظ القيم الخمسة فقط =========
    function persistUserFields({userId, name, birth, phone, email}) {
      sessionStorage.setItem("userId", userId || "");
      sessionStorage.setItem("name", name || "");
      sessionStorage.setItem("birth", birth || "");
      sessionStorage.setItem("phone number", phone || ""); // الاسم كما طُلب
      sessionStorage.setItem("email", email || "");
    }
    function clearUserFields() {
      ["userId","name","birth","phone number","email"].forEach(k=>sessionStorage.removeItem(k));
    }

    // ========= UI =========
    function renderFromSession() {
      const data = {
        userId: sessionStorage.getItem("userId"),
        name: sessionStorage.getItem("name"),
        birth: sessionStorage.getItem("birth"),
        phone: sessionStorage.getItem("phone number"),
        email: sessionStorage.getItem("email"),
      };
      const signedIn = !!data.userId;
      $("#signed-out").style.display = signedIn ? "none" : "";
      $("#signed-in").style.display  = signedIn ? "" : "none";
      if (!signedIn) return;

      const rows = [
        ["program", CONFIG.PROGRAM_NAME],
        ["userId", data.userId],
        ["name", data.name],
        ["birth", data.birth],
        ["email", data.email],
        ["phone number", data.phone],
      ];
      const grid = $("#claims"); grid.innerHTML = "";
      for (const [k,v] of rows) {
        const row = document.createElement("div"); row.className="row";
        const key = Object.assign(document.createElement("div"), {className:"key", textContent:k});
        const val = Object.assign(document.createElement("div"), {className:"val", textContent: v || "—"});
        if (k==="email" || k==="phone number") val.classList.add("ltr");
        row.append(key,val); grid.append(row);
      }
    }

    // ========= Auth Flow =========
    function startLogin() {
      createPKCE().then(({verifier, challenge})=>{
        const state = randStr(32);
        tempStore.set(TMP.PKCE_VERIFIER, verifier);
        tempStore.set(TMP.OAUTH_STATE, state);

        const url = new URL(CONFIG.COGNITO_DOMAIN + "/oauth2/authorize");
        url.searchParams.set("response_type","code");
        url.searchParams.set("client_id", CONFIG.CLIENT_ID);
        url.searchParams.set("redirect_uri", CONFIG.REDIRECT_URI);
        url.searchParams.set("scope", CONFIG.SCOPES.join(" "));
        url.searchParams.set("code_challenge_method","S256");
        url.searchParams.set("code_challenge", challenge);
        url.searchParams.set("state", state);
        location.assign(url.toString());
      }).catch(()=>msg("تعذر بدء تسجيل الدخول (PKCE).", false));
    }

    async function handleCallback(code) {
      const verifier = tempStore.get(TMP.PKCE_VERIFIER);
      const expectedState = tempStore.get(TMP.OAUTH_STATE);
      const gotState = new URL(location.href).searchParams.get("state");
      if (expectedState && gotState && expectedState !== gotState) throw new Error("STATE_MISMATCH");

      const body = new URLSearchParams({
        grant_type:"authorization_code",
        client_id:CONFIG.CLIENT_ID,
        code, redirect_uri:CONFIG.REDIRECT_URI
      });
      if (verifier) body.set("code_verifier", verifier); // يستخدم PKCE لو متاح

      const resp = await fetch(CONFIG.COGNITO_DOMAIN + "/oauth2/token", {
        method:"POST", headers:{ "Content-Type":"application/x-www-form-urlencoded" }, body
      });
      if (!resp.ok) throw new Error("TOKEN_EXCHANGE_FAILED");
      const tokens = await resp.json();
      tempStore.del(TMP.PKCE_VERIFIER); tempStore.del(TMP.OAUTH_STATE);

      const idClaims = decodeJwt(tokens.id_token || "");
      let info = {};
      try {
        const u = await fetch(CONFIG.COGNITO_DOMAIN + "/oauth2/userInfo", {
          headers: { Authorization: "Bearer " + tokens.access_token }
        });
        if (u.ok) info = await u.json();
      } catch {}

      const full = Object.assign({}, idClaims, info);
      const user = {
        userId: full.sub || idClaims.sub || "",
        name: full.name || [full.given_name, full.family_name].filter(Boolean).join(" ") || "",
        birth: full.birthdate || idClaims.birthdate || "",
        phone: full.phone_number || "",
        email: full.email || "",
      };
      persistUserFields(user);
    }

    // ========= Init =========
    async function init() {
      $("#btnSignIn").onclick = startLogin;
      $("#btnClearLocal").onclick = ()=>{ clearUserFields(); renderFromSession(); msg("تم مسح SessionStorage.", true); };
      $("#btnCopy").onclick = async ()=>{
        const keys = ["userId","name","birth","phone number","email"];
        const out = Object.fromEntries(keys.map(k=>[k, sessionStorage.getItem(k) || ""]));
        await navigator.clipboard.writeText(JSON.stringify(out,null,2));
        msg("تم نسخ القيم الخمسة.", true);
      };
      $("#btnSignOut").onclick = ()=>{
        clearUserFields(); renderFromSession(); msg("تم مسح الجلسة محليًا.", true);
        try {
          const url = new URL(CONFIG.COGNITO_DOMAIN + "/logout");
          url.searchParams.set("client_id", CONFIG.CLIENT_ID);
          url.searchParams.set("logout_uri", CONFIG.REDIRECT_URI);
          // location.assign(url); // فعّل لو عايز خروج كامل من Hosted UI
        } catch {}
      };

      const url = new URL(location.href);
      const code = url.searchParams.get("code");
      if (code) {
        try {
          await handleCallback(code);
          url.searchParams.delete("code"); url.searchParams.delete("state");
          history.replaceState(null,"",url.toString());
          msg("تم تسجيل الدخول وحفظ القيم الخمسة.");
        } catch(e) {
          console.error(e); msg(e.message || "خطأ أثناء إتمام تسجيل الدخول.", false);
        }
      }
      renderFromSession();
    }
    init();
  </script>
</body>
</html>

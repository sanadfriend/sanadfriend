<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>sanad friend — تسجيل الدخول</title>
  <style>
    :root{--bg:#0b1224;--card:#0f1b37;--muted:#91a4c7;--txt:#e9eef9;--accent:#4cc9f0}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1224,#0e1630 40%,#0b1224);color:var(--txt);
      font-family:"Cairo","Tajawal",system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:820px;margin:7vh auto;padding:16px}
    .card{background:var(--card);border:1px solid #1d2a52;border-radius:20px;box-shadow:0 20px 60px #00000055;padding:22px}
    h1{margin:0 0 10px;font-weight:800}
    p.muted{color:var(--muted);margin:4px 0 18px}
    button{cursor:pointer;border:1px solid #27406f;background:#152857;color:#fff;padding:12px 18px;border-radius:14px;font-weight:700}
    button.primary{background:linear-gradient(135deg,#2563eb,#4cc9f0);border:0}
    button.ghost{background:transparent;border:1px dashed #305095}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px dashed #24417a;border-radius:12px;padding:10px 12px}
    .key{color:#98b0dc;font-size:.95rem}.val{font-weight:700}
    .footer{opacity:.75;font-size:.9rem;margin-top:14px}
    .ltr{direction:ltr;unicode-bidi:plaintext}
    /* Spinner */
    #spinner{position:fixed;inset:0;background:#0b1224cc;display:none;align-items:center;justify-content:center;z-index:9999}
    .spin-box{display:flex;gap:14px;align-items:center;background:#0e1a36;border:1px solid #20325f;border-radius:16px;padding:14px 18px;box-shadow:0 12px 36px #0008}
    .wheel{width:26px;height:26px;border:3px solid #3b569b;border-top-color:#4cc9f0;border-radius:50%;animation:sp 0.9s linear infinite}
    @keyframes sp{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- Spinner -->
  <div id="spinner" aria-hidden="true">
    <div class="spin-box"><div class="wheel"></div><div id="spin-text">جارٍ المعالجة…</div></div>
  </div>
<a href="case uploud.html"><button>aaa</button></a>
  <div class="wrap">
    <div class="card">
      <h1>sanad friend — تسجيل الدخول</h1>
      <p class="muted">بعد نجاح الدخول، نحفظ القيم: <b>userId / name / birth / phone number / email</b> كل واحدة بمفتاح مستقل في <code>sessionStorage</code>.</p>

      <div style="display:flex;gap:10px;margin-bottom:14px">
        <button id="btnLogin" class="primary">تسجيل الدخول</button>
        <button id="btnLogout" class="ghost">تسجيل الخروج (مسح القيم)</button>
        <button id="btnCopy" class="ghost">نسخ القيم الخمسة</button>
      </div>

      <div class="grid" id="claims"></div>
      <p class="footer" id="msg"></p>
    </div>
  </div>

  <script>
    /* ========= إعدادات ========= */
    const CONFIG = {
      COGNITO_DOMAIN: "https://us-east-1fth1loy0b.auth.us-east-1.amazoncognito.com",
      CLIENT_ID:      "1ckgnpptbiq3aopekr9kt54aoh",
      REDIRECT_URI:   "https://sanadfriend.github.io/sanadfriend/", // نفس المسجل في Cognito
      SCOPES:         "openid email phone profile"
    };

    /* ========= سبينر / رسائل ========= */
    const $ = s => document.querySelector(s);
    const showSpin = (t="جارٍ المعالجة…") => { const x=$("#spinner"); if(!x) return; $("#spin-text").textContent=t; x.style.display="flex"; };
    const hideSpin = () => { const x=$("#spinner"); if(x) x.style.display="none"; };
    const msg = (t,ok=true) => { const el=$("#msg"); el.textContent=t||""; el.style.color = ok ? "#9fe6b8" : "#ffb4b4"; };

    /* ========= Helpers ========= */
    const getParams = () => Object.fromEntries(new URL(location.href).searchParams.entries());
    const b64urlToUint8 = (s)=>{ s=s.replace(/-/g,"+").replace(/_/g,"/"); const pad=s.length%4?4-(s.length%4):0; const b64=s+"=".repeat(pad);
      const raw=atob(b64); return Uint8Array.from(raw, c=>c.charCodeAt(0)); };
    const decodeJwt = (jwt)=>{ try{ const p=jwt.split(".")[1]; return JSON.parse(new TextDecoder().decode(b64urlToUint8(p))); }catch{return {}}; };

    /* ========= تخزين الخمس قيم فقط ========= */
    function persistFive({userId,name,birth,phone,email}) {
      sessionStorage.setItem("userId", userId || "");
      sessionStorage.setItem("name", name || "");
      sessionStorage.setItem("birth", birth || "");
      sessionStorage.setItem("phone number", phone || "");
      sessionStorage.setItem("email", email || "");
    }
    function clearFive() {
      ["userId","name","birth","phone number","email"].forEach(k=>sessionStorage.removeItem(k));
    }

    /* ========= عرض القيم ========= */
    function renderFromSession() {
      const v = {
        userId: sessionStorage.getItem("userId") || "",
        name:   sessionStorage.getItem("name") || "",
        birth:  sessionStorage.getItem("birth") || "",
        email:  sessionStorage.getItem("email") || "",
        phone:  sessionStorage.getItem("phone number") || "",
      };
      const grid = $("#claims"); grid.innerHTML="";
      [["userId",v.userId],["name",v.name],["birth",v.birth],["email",v.email],["phone number",v.phone]].forEach(([k,val])=>{
        const row = document.createElement("div"); row.className="row";
        const a = Object.assign(document.createElement("div"),{className:"key",textContent:k});
        const b = Object.assign(document.createElement("div"),{className:"val",textContent: val || "—"});
        if (k==="email"||k==="phone number") b.classList.add("ltr");
        row.append(a,b); grid.append(row);
      });
    }

    /* ========= بدء تسجيل الدخول (مع PKCE اختياريًا للتوافق) ========= */
    async function startLogin() {
      showSpin("جارٍ التحويل لصفحة الدخول…");
      // PKCE (اختياري لزيادة التوافق). نحفظ الـ verifier مؤقتًا
      const verifier = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(32))))
        .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
      const challenge = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(verifier))
        .then(buf => btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""));
      try { sessionStorage.setItem("SF_PKCE_VERIFIER", verifier); } catch {}
      // state للاحتياط (مش هنفشل لو مرجعش)
      const state = Math.random().toString(36).slice(2);
      try { sessionStorage.setItem("SF_STATE", state); } catch {}

      const url = new URL(`${CONFIG.COGNITO_DOMAIN}/oauth2/authorize`);
      url.searchParams.set("response_type","code");
      url.searchParams.set("client_id",CONFIG.CLIENT_ID);
      url.searchParams.set("redirect_uri",CONFIG.REDIRECT_URI);
      url.searchParams.set("scope",CONFIG.SCOPES);
      url.searchParams.set("code_challenge_method","S256");
      url.searchParams.set("code_challenge",challenge);
      url.searchParams.set("state",state);
      location.assign(url.toString());
    }

    /* ========= Callback: code -> token -> userInfo -> حفظ الخمس ========= */
    async function handleCognitoCallback() {
      const { code } = getParams();
      if (!code) return;
      try {
        showSpin("جارٍ تبادل الكود…");
        const verifier = sessionStorage.getItem("SF_PKCE_VERIFIER"); // لو موجود نستخدمه

        const body = new URLSearchParams({
          grant_type: "authorization_code",
          client_id:  CONFIG.CLIENT_ID,
          code,
          redirect_uri: CONFIG.REDIRECT_URI
        });
        if (verifier) body.set("code_verifier", verifier);

        const tokenRes = await fetch(`${CONFIG.COGNITO_DOMAIN}/oauth2/token`, {
          method: "POST",
          headers: {"Content-Type":"application/x-www-form-urlencoded"},
          body
        });
        if (!tokenRes.ok) throw new Error("TOKEN_EXCHANGE_FAILED");
        const tokens = await tokenRes.json();
        const idClaims = decodeJwt(tokens.id_token || "");

        showSpin("جارٍ جلب بيانات المستخدم…");
        let ui = {};
        const uiRes = await fetch(`${CONFIG.COGNITO_DOMAIN}/oauth2/userInfo`, {
          method: "GET",
          headers: { Authorization: `Bearer ${tokens.access_token}` }
        });
        if (uiRes.ok) ui = await uiRes.json();

        const userId = ui.sub || idClaims.sub || "";
        const name   = ui.name || [ui.given_name, ui.family_name].filter(Boolean).join(" ") || idClaims.name || "";
        const birth  = ui.birthdate || idClaims.birthdate || "";
        const phone  = (ui.phone_number || idClaims.phone_number || "").replace(/\s+/g,"");
        const email  = ui.email || idClaims.email || "";

        persistFive({userId,name,birth,phone,email});

        // تنظيف URL
        const url = new URL(location.href);
        url.searchParams.delete("code"); url.searchParams.delete("state");
        history.replaceState(null,"",url.toString());

        hideSpin(); msg("تم حفظ القيم في sessionStorage."); renderFromSession();
      } catch (e) {
        hideSpin(); console.error(e); msg("فشل إتمام تسجيل الدخول.", false);
      } finally {
        sessionStorage.removeItem("SF_PKCE_VERIFIER");
        sessionStorage.removeItem("SF_STATE");
      }
    }

    /* ========= أحداث ========= */
    document.getElementById("btnLogin").onclick  = startLogin;
    document.getElementById("btnLogout").onclick = ()=>{
      clearFive(); renderFromSession(); msg("تم مسح القيم.", true);
      // خروج كامل من Hosted UI (اختياري): 
      // location.assign(`${CONFIG.COGNITO_DOMAIN}/logout?client_id=${CONFIG.CLIENT_ID}&logout_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}`);
    };
    document.getElementById("btnCopy").onclick = async ()=>{
      const keys=["userId","name","birth","phone number","email"];
      const out=Object.fromEntries(keys.map(k=>[k,sessionStorage.getItem(k)||""]));
      await navigator.clipboard.writeText(JSON.stringify(out,null,2));
      msg("تم نسخ القيم الخمسة.", true);
    };

    /* ========= تشغيل أولي ========= */
    (async function init(){
      await handleCognitoCallback();
      renderFromSession();
    })();
  </script>
</body>
</html>


<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>sanad friend — تسجيل الدخول</title>
  <style>
    :root{--bg:#0b1224;--card:#101a34;--muted:#8fa3c7;--txt:#e9eef9;--accent:#4cc9f0;--ok:#22c55e;--err:#ef4444}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1224,#0e1630 40%,#0b1224);
    color:var(--txt);font-family:"Cairo","Tajawal",system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.7}
    .wrap{max-width:780px;margin:6vh auto;padding:16px}
    .card{background:var(--card);border:1px solid #1d2a52;border-radius:20px;box-shadow:0 20px 60px #00000055;padding:22px}
    h1{margin:0 0 10px;font-weight:800;letter-spacing:.2px}
    p.muted{color:var(--muted);margin:4px 0 18px}
    button{cursor:pointer;border:1px solid #27406f;background:#152857;color:#fff;padding:12px 18px;border-radius:14px;font-weight:700}
    button.primary{background:linear-gradient(135deg,#2563eb,#4cc9f0);border:0}
    button.link{background:transparent;border:0;color:#a6c8ff;text-decoration:underline;padding:0}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px dashed #24417a;border-radius:12px;padding:10px 12px}
    .key{color:#98b0dc;font-size:.95rem} .val{font-weight:700}
    .good{color:var(--ok)} .bad{color:var(--err)}
    .footer{opacity:.7;font-size:.9rem;margin-top:14px}
    code{background:#0b1329;border:1px solid #20325f;border-radius:8px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>sanad friend — تسجيل الدخول</h1>
      <p class="muted">تسجيل آمن عبر Amazon Cognito (Authorization Code + PKCE). بعد نجاح الدخول، بياناتك تتخزن في <code>sessionStorage</code> لاستخدامها داخل الصفحة فقط.</p>

      <div id="signed-out">
        <button id="btnSignIn" class="primary">تسجيل الدخول</button>
      </div>

      <div id="signed-in" style="display:none">
        <div class="grid" id="claims"></div>
        <div style="display:flex;gap:10px;margin-top:14px">
          <button id="btnCopy">نسخ بيانات الجلسة</button>
          <button id="btnSignOut">تسجيل الخروج</button>
          <button id="btnClearLocal" class="link" title="مسح التخزين المؤقت فقط">مسح SessionStorage فقط</button>
        </div>
        <p class="footer">المفاتيح المستخدمة: <code>SANADF_USER</code> و <code>SANADF_TOKENS</code></p>
      </div>

      <p id="msg" class="footer"></p>
    </div>
  </div>

  <script>
    // ====== 1) إعدادات Cognito (حدّث الـ DOMAIN فقط إن لزم) ====================
    const CONFIG = Object.freeze({
      PROGRAM_NAME: "sanad friend",
      REGION: "us-east-1",
      USER_POOL_ID: "us-east-1_FtH1LOY0B",
      CLIENT_ID: "1ckgnpptbiq3aopekr9kt54aoh", // لو اختلفت عندك انسخها من الكونسول
      // غيّر الدومين حسب الدومين اللي اخترته في Hosted UI (مثال موضح):
      COGNITO_DOMAIN: "https://YOUR-DOMAIN.auth.us-east-1.amazoncognito.com",
      REDIRECT_URI: "https://sanadfriend.github.io/sanadfriend/",
      SCOPES: ["openid","email","phone","profile"], // لو profile مش مفعّل، فعّله من App client
    });

    // مفاتيح التخزين المحلي
    const K = Object.freeze({
      PKCE_VERIFIER: "SF_PKCE_VERIFIER",
      OAUTH_STATE: "SF_OAUTH_STATE",
      TOKENS: "SANADF_TOKENS",
      USER: "SANADF_USER",
    });

    // ====== 2) أدوات مساعدة (PKCE/JWT/Storage/UI) ==============================
    const $ = (sel) => document.querySelector(sel);
    const b64url = (buf) => {
      let str = typeof buf === "string" ? buf : String.fromCharCode(...new Uint8Array(buf));
      return btoa(str).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    };
    const b64urlToUint8 = (b64urlStr) => {
      b64urlStr = b64urlStr.replace(/-/g, "+").replace(/_/g, "/");
      const pad = b64urlStr.length % 4 ? 4 - (b64urlStr.length % 4) : 0;
      const b64 = b64urlStr + "=".repeat(pad);
      const raw = atob(b64);
      const out = new Uint8Array(raw.length);
      for (let i=0;i<raw.length;i++) out[i] = raw.charCodeAt(i);
      return out;
    };
    const sha256 = async (str) => {
      const data = new TextEncoder().encode(str);
      return crypto.subtle.digest("SHA-256", data);
    };
    const randomString = (len=64) => {
      const arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      return b64url(arr);
    };
    const createPKCE = async () => {
      const verifier = randomString(64);
      const challenge = b64url(await sha256(verifier));
      return { verifier, challenge };
    };
    const decodeJwt = (jwt) => {
      const [h, p] = jwt.split(".");
      try {
        const json = new TextDecoder().decode(b64urlToUint8(p));
        return JSON.parse(json);
      } catch { return {}; }
    };
    const save = (k, v) => sessionStorage.setItem(k, JSON.stringify(v));
    const load = (k) => { try { return JSON.parse(sessionStorage.getItem(k)); } catch { return null; } };
    const clearKeys = (...keys) => keys.forEach(k=>sessionStorage.removeItem(k));

    const message = (txt, ok=true) => {
      const el = $("#msg");
      el.textContent = txt || "";
      el.style.color = ok ? "#9fe6b8" : "#ffb4b4";
    };

    // ====== 3) تدفق الدخول: Authorize ثم تبادل الكود بـ Tokens ==================
    function authorizeRedirect() {
      createPKCE().then(({verifier, challenge}) => {
        const state = randomString(32);
        save(K.PKCE_VERIFIER, verifier);
        save(K.OAUTH_STATE, state);

        const url = new URL(CONFIG.COGNITO_DOMAIN + "/oauth2/authorize");
        url.searchParams.set("response_type", "code");
        url.searchParams.set("client_id", CONFIG.CLIENT_ID);
        url.searchParams.set("redirect_uri", CONFIG.REDIRECT_URI);
        url.searchParams.set("scope", CONFIG.SCOPES.join(" "));
        url.searchParams.set("code_challenge_method", "S256");
        url.searchParams.set("code_challenge", challenge);
        url.searchParams.set("state", state);

        location.assign(url.toString());
      }).catch(() => message("تعذر بدء تسجيل الدخول (PKCE).", false));
    }

    async function exchangeCodeForTokens(code) {
      const verifier = load(K.PKCE_VERIFIER);
      const state = load(K.OAUTH_STATE);
      const gotState = new URL(location.href).searchParams.get("state");
      if (!verifier || !state || gotState !== state) throw new Error("STATE_INVALID");

      const body = new URLSearchParams({
        grant_type: "authorization_code",
        client_id: CONFIG.CLIENT_ID,
        code,
        redirect_uri: CONFIG.REDIRECT_URI,
        code_verifier: verifier
      });

      const resp = await fetch(CONFIG.COGNITO_DOMAIN + "/oauth2/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });
      if (!resp.ok) throw new Error("TOKEN_EXCHANGE_FAILED");
      const tokens = await resp.json(); // {access_token, id_token, refresh_token?, expires_in, token_type}
      save(K.TOKENS, tokens);
      clearKeys(K.PKCE_VERIFIER, K.OAUTH_STATE);

      // Claims من الـ ID Token
      const idClaims = decodeJwt(tokens.id_token || "");
      // نجلب userInfo (يعتمد على الـ scopes)
      let info = {};
      try {
        const u = await fetch(CONFIG.COGNITO_DOMAIN + "/oauth2/userInfo", {
          headers: { "Authorization": "Bearer " + tokens.access_token }
        });
        if (u.ok) info = await u.json();
      } catch {}

      // نجمع ونخزن
      const full = Object.assign({}, idClaims, info);
      const user = {
        program: CONFIG.PROGRAM_NAME,
        userId: full.sub || idClaims.sub,
        username: full["cognito:username"] || idClaims["cognito:username"],
        email: full.email,
        email_verified: full.email_verified,
        phone: full.phone_number,
        phone_verified: full.phone_number_verified,
        name: full.name || [full.given_name, full.family_name].filter(Boolean).join(" ") || "(بدون اسم)",
        picture: full.picture,
        exp: idClaims.exp,
        iat: idClaims.iat,
        auth_time: idClaims.auth_time
      };
      save(K.USER, user);
      return user;
    }

    // ====== 4) UI ==============================================================
    function render(user) {
      const signedIn = !!user;
      $("#signed-out").style.display = signedIn ? "none" : "";
      $("#signed-in").style.display  = signedIn ? "" : "none";
      if (!signedIn) return;

      const list = [
        ["program","sanad friend"],
        ["userId (sub)", user.userId],
        ["username", user.username],
        ["name", user.name],
        ["email", user.email],
        ["phone", user.phone],
        ["email_verified", user.email_verified ? "true":"false"],
        ["phone_verified", user.phone_verified ? "true":"false"],
        ["token_exp(unix)", user.exp],
      ];

      const grid = $("#claims");
      grid.innerHTML = "";
      for (const [k,v] of list) {
        const row = document.createElement("div");
        row.className = "row";
        const key = document.createElement("div"); key.className = "key"; key.textContent = k;
        const val = document.createElement("div"); val.className = "val"; val.textContent = v ?? "—";
        if (k.endsWith("_verified")) val.classList.add(v==="true"?"good":"bad");
        row.append(key,val); grid.append(row);
      }
    }

    async function init() {
      $("#btnSignIn").onclick = authorizeRedirect;
      $("#btnSignOut").onclick = () => {
        const tokens = load(K.TOKENS);
        clearKeys(K.USER, K.TOKENS, K.PKCE_VERIFIER, K.OAUTH_STATE);
        render(null);
        message("تم مسح الجلسة محليًا.", true);

        // لو مفعّل Allowed sign-out URLs، نقدر نخرج من الـ Hosted UI نفسه:
        try {
          const url = new URL(CONFIG.COGNITO_DOMAIN + "/logout");
          url.searchParams.set("client_id", CONFIG.CLIENT_ID);
          url.searchParams.set("logout_uri", CONFIG.REDIRECT_URI);
          // اختيارى: location.assign(url);
        } catch {}
      };

      $("#btnClearLocal").onclick = () => { clearKeys(K.USER, K.TOKENS); render(null); message("تم مسح sessionStorage.", true); };
      $("#btnCopy").onclick = async () => {
        const data = { user: load(K.USER), tokens: load(K.TOKENS) };
        await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
        message("تم نسخ بيانات الجلسة.", true);
      };

      // لو راجعين من Cognito ومعانا code
      const url = new URL(location.href);
      const code = url.searchParams.get("code");
      if (code) {
        try {
          const user = await exchangeCodeForTokens(code);
          // نزيل بارامترات الكولباك من العنوان
          url.searchParams.delete("code");
          url.searchParams.delete("state");
          history.replaceState(null, "", url.toString());
          render(user);
          message("تم تسجيل الدخول بنجاح.");
          return;
        } catch (e) {
          console.error(e);
          message("فشل إتمام تسجيل الدخول. افحص الإعدادات (domain/scopes) أو أعد المحاولة.", false);
        }
      }

      // حالة قديمة محفوظة
      render(load(K.USER));
    }

    init();
  </script>
</body>
</html>

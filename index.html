<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>sanad friend — تسجيل الدخول</title>
  <!-- فاف آيكون لتصفير 404 -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%232563eb'/%3E%3Ctext x='32' y='40' text-anchor='middle' font-size='28' fill='white' font-family='Arial'%3ESF%3C/text%3E%3C/svg%3E">
  <style>
    :root{--bg:#0b1224;--card:#101a34;--muted:#8fa3c7;--txt:#e9eef9;--accent:#4cc9f0;--ok:#22c55e;--err:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1224,#0e1630 40%,#0b1224);color:var(--txt);
      font-family:"Cairo","Tajawal",system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.7}
    .wrap{max-width:780px;margin:6vh auto;padding:16px}
    .card{background:var(--card);border:1px solid #1d2a52;border-radius:20px;box-shadow:0 20px 60px #00000055;padding:22px}
    h1{margin:0 0 10px;font-weight:800}
    p.muted{color:var(--muted);margin:4px 0 18px}
    button{cursor:pointer;border:1px solid #27406f;background:#152857;color:#fff;padding:12px 18px;border-radius:14px;font-weight:700}
    button.primary{background:linear-gradient(135deg,#2563eb,#4cc9f0);border:0}
    button.link{background:transparent;border:0;color:#a6c8ff;text-decoration:underline;padding:0}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px dashed #24417a;border-radius:12px;padding:10px 12px}
    .key{color:#98b0dc;font-size:.95rem}.val{font-weight:700}
    .good{color:var(--ok)} .bad{color:var(--err)}
    .footer{opacity:.7;font-size:.9rem;margin-top:14px}
    code{background:#0b1329;border:1px solid #20325f;border-radius:8px;padding:2px 6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>sanad friend — تسجيل الدخول</h1>
      <p class="muted">تسجيل آمن عبر Amazon Cognito (Authorization Code + PKCE). بعد نجاح الدخول، بنحفظ بياناتك داخل <code>sessionStorage</code> في نفس الصفحة.</p>

      <div id="signed-out"><button id="btnSignIn" class="primary">تسجيل الدخول</button></div>

      <div id="signed-in" style="display:none">
        <div class="grid" id="claims"></div>
        <div style="display:flex;gap:10px;margin-top:14px">
          <button id="btnCopy">نسخ بيانات الجلسة</button>
          <button id="btnSignOut">تسجيل الخروج</button>
          <button id="btnClearLocal" class="link" title="مسح التخزين المؤقت فقط">مسح SessionStorage فقط</button>
        </div>
        <p class="footer">المفاتيح: <code>SANADF_USER</code> و <code>SANADF_TOKENS</code></p>
      </div>

      <p id="msg" class="footer"></p>
    </div>
  </div>

  <script>
    // ===== 1) إعداداتك (حدث الدومين) ==========================================
    const CONFIG = Object.freeze({
      PROGRAM_NAME: "sanad friend",
      REGION: "us-east-1",
      USER_POOL_ID: "us-east-1_FtH1LOY0B",
      CLIENT_ID: "1ckgnpptbiq3aopekr9kt54aoh",
      COGNITO_DOMAIN: "https://us-east-1fth1loy0b.auth.us-east-1.amazoncognito.com/login?client_id=1ckgnpptbiq3aopekr9kt54aoh&redirect_uri=https://sanadfriend.github.io/sanadfriend/&response_type=code&scope=email+openid+phone", // ← غيّره
      REDIRECT_URI: "https://sanadfriend.github.io/sanadfriend/",
      SCOPES: ["openid","email","phone","profile"],
    });

    // مفاتيح التخزين
    const K = Object.freeze({
      PKCE_VERIFIER: "SF_PKCE_VERIFIER",
      OAUTH_STATE: "SF_OAUTH_STATE",
      TOKENS: "SANADF_TOKENS",     // sessionStorage
      USER: "SANADF_USER",         // sessionStorage
    });

    // ===== 2) Utilities ========================================================
    const $ = s => document.querySelector(s);
    const b64url = (buf) => {
      let str = typeof buf === "string" ? buf : String.fromCharCode(...new Uint8Array(buf));
      return btoa(str).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
    };
    const b64urlToUint8 = (s) => {
      s = s.replace(/-/g, "+").replace(/_/g, "/"); const pad = s.length % 4 ? 4 - (s.length % 4) : 0;
      const b64 = s + "=".repeat(pad); const raw = atob(b64); const out = new Uint8Array(raw.length);
      for (let i=0;i<raw.length;i++) out[i]=raw.charCodeAt(i); return out;
    };
    const sha256 = async (str) => crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
    const randomString = (len=64) => { const a=new Uint8Array(len); crypto.getRandomValues(a); return b64url(a); };
    const createPKCE = async () => { const verifier = randomString(64); const challenge = b64url(await sha256(verifier)); return {verifier,challenge}; };
    const decodeJwt = (jwt) => { const [,p] = String(jwt).split("."); try{ return JSON.parse(new TextDecoder().decode(b64urlToUint8(p))); }catch{ return {}; } };
    const message = (t, ok=true) => { const el=$("#msg"); el.textContent=t||""; el.style.color= ok ? "#9fe6b8" : "#ffb4b4"; };

    // تخزين مؤقت resilient (PKCE/state) → يكتب في sessionStorage وlocalStorage
    const tempStore = {
      set: (k,v) => { try{sessionStorage.setItem(k,JSON.stringify(v));}catch{} try{localStorage.setItem(k,JSON.stringify(v));}catch{} },
      get: (k)   => { let v=null; try{v=sessionStorage.getItem(k);}catch{} if(v==null){ try{v=localStorage.getItem(k);}catch{} }
                      try{return v!=null?JSON.parse(v):null;}catch{return null;} },
      del: (k)   => { try{sessionStorage.removeItem(k);}catch{} try{localStorage.removeItem(k);}catch{} },
    };
    const ss = {
      set:(k,v)=>sessionStorage.setItem(k,JSON.stringify(v)),
      get:(k)=>{try{return JSON.parse(sessionStorage.getItem(k));}catch{return null;}},
      del:(...ks)=>ks.forEach(k=>sessionStorage.removeItem(k))
    };

    // ===== 3) Auth Flow ========================================================
    function authorizeRedirect() {
      createPKCE().then(({verifier, challenge}) => {
        const state = randomString(32);
        tempStore.set(K.PKCE_VERIFIER, verifier);
        tempStore.set(K.OAUTH_STATE, state);

        const url = new URL(CONFIG.COGNITO_DOMAIN + "/oauth2/authorize");
        url.searchParams.set("response_type","code");
        url.searchParams.set("client_id", CONFIG.CLIENT_ID);
        url.searchParams.set("redirect_uri", CONFIG.REDIRECT_URI);
        url.searchParams.set("scope", CONFIG.SCOPES.join(" "));
        url.searchParams.set("code_challenge_method","S256");
        url.searchParams.set("code_challenge", challenge);
        url.searchParams.set("state", state);
        location.assign(url.toString());
      }).catch(()=> message("تعذر بدء تسجيل الدخول (PKCE).", false));
    }

    async function exchangeCodeForTokens(code) {
      const verifier = tempStore.get(K.PKCE_VERIFIER);
      const expectedState = tempStore.get(K.OAUTH_STATE);
      const gotState = new URL(location.href).searchParams.get("state");
      if (!verifier || !expectedState || gotState !== expectedState) throw new Error("STATE_INVALID");

      const body = new URLSearchParams({
        grant_type: "authorization_code",
        client_id: CONFIG.CLIENT_ID,
        code, redirect_uri: CONFIG.REDIRECT_URI, code_verifier: verifier
      });

      const resp = await fetch(CONFIG.COGNITO_DOMAIN + "/oauth2/token", {
        method: "POST", headers: {"Content-Type":"application/x-www-form-urlencoded"}, body
      });
      if (!resp.ok) throw new Error("TOKEN_EXCHANGE_FAILED");
      const tokens = await resp.json();
      ss.set(K.TOKENS, tokens);
      tempStore.del(K.PKCE_VERIFIER); tempStore.del(K.OAUTH_STATE);

      const idClaims = decodeJwt(tokens.id_token || "");
      let info = {};
      try {
        const u = await fetch(CONFIG.COGNITO_DOMAIN + "/oauth2/userInfo", {
          headers: { Authorization: "Bearer " + tokens.access_token }
        });
        if (u.ok) info = await u.json();
      } catch {}

      const full = Object.assign({}, idClaims, info);
      const user = {
        program: CONFIG.PROGRAM_NAME,
        userId: full.sub || idClaims.sub,
        username: full["cognito:username"] || idClaims["cognito:username"],
        email: full.email, email_verified: full.email_verified,
        phone: full.phone_number, phone_verified: full.phone_number_verified,
        name: full.name || [full.given_name, full.family_name].filter(Boolean).join(" ") || "(بدون اسم)",
        picture: full.picture, exp: idClaims.exp, iat: idClaims.iat, auth_time: idClaims.auth_time
      };
      ss.set(K.USER, user);
      return user;
    }

    // ===== 4) UI ===============================================================
    const render = (user) => {
      const signedIn = !!user;
      $("#signed-out").style.display = signedIn ? "none" : "";
      $("#signed-in").style.display  = signedIn ? "" : "none";
      if (!signedIn) return;

      const rows = [
        ["program","sanad friend"],
        ["userId (sub)", user.userId],
        ["username", user.username],
        ["name", user.name],
        ["email", user.email],
        ["phone", user.phone],
        ["email_verified", user.email_verified ? "true":"false"],
        ["phone_verified", user.phone_verified ? "true":"false"],
        ["token_exp(unix)", user.exp],
      ];
      const grid = $("#claims"); grid.innerHTML = "";
      for (const [k,v] of rows) {
        const row = document.createElement("div"); row.className="row";
        const key = Object.assign(document.createElement("div"), {className:"key", textContent:k});
        const val = Object.assign(document.createElement("div"), {className:"val", textContent: v ?? "—"});
        if (k.endsWith("_verified")) val.classList.add(v==="true"?"good":"bad");
        row.append(key,val); grid.append(row);
      }
    };

    async function init() {
      $("#btnSignIn").onclick   = authorizeRedirect;
      $("#btnCopy").onclick     = async () => {
        const data = { user: ss.get(K.USER), tokens: ss.get(K.TOKENS) };
        await navigator.clipboard.writeText(JSON.stringify(data,null,2));
        message("تم نسخ بيانات الجلسة.", true);
      };
      $("#btnClearLocal").onclick = () => { ss.del(K.USER,K.TOKENS); render(null); message("تم مسح sessionStorage.", true); };
      $("#btnSignOut").onclick  = () => {
        const t = ss.get(K.TOKENS);
        ss.del(K.USER,K.TOKENS); render(null); message("تم مسح الجلسة محليًا.", true);
        try {
          const url = new URL(CONFIG.COGNITO_DOMAIN + "/logout");
          url.searchParams.set("client_id", CONFIG.CLIENT_ID);
          url.searchParams.set("logout_uri", CONFIG.REDIRECT_URI);
          // location.assign(url); // فعّل لو عايز خروج كامل من Hosted UI
        } catch {}
      };

      const url = new URL(location.href);
      const code = url.searchParams.get("code");
      if (code) {
        try {
          const user = await exchangeCodeForTokens(code);
          url.searchParams.delete("code"); url.searchParams.delete("state");
          history.replaceState(null,"",url.toString());
          render(user); message("تم تسجيل الدخول بنجاح."); return;
        } catch(e) {
          console.error(e); message(e.message==="STATE_INVALID"?
            "STATE_INVALID: المتغيرات المؤقتة مفقودة. اضغط تسجيل الدخول من الصفحة نفسها مرة أخرى.":
            "فشل إتمام تسجيل الدخول. راجع الدومين/الأذونات.", false);
        }
      }
      render(ss.get(K.USER));
    }
    init();
  </script>
</body>
</html>
